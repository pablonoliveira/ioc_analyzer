<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOC Analysis CRUD</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
            --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family-base); background-color: var(--color-background); color: var(--color-text); padding: var(--space-24); line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { margin-bottom: var(--space-32); }
        h1 { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); margin-bottom: var(--space-8); }
        .subtitle { color: var(--color-text-secondary); font-size: var(--font-size-base); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-16); margin-bottom: var(--space-32); }
        .stat-card { background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); box-shadow: var(--shadow-sm); }
        .stat-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4); text-transform: uppercase; font-weight: var(--font-weight-medium); }
        .stat-value { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-text); }
        .stat-value.critical { color: var(--color-error); }
        .stat-value.high { color: var(--color-warning); }
        .stat-value.medium { color: var(--color-primary); }
        .form-card { background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-24); margin-bottom: var(--space-24); box-shadow: var(--shadow-sm); }
        .form-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-20); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-16); margin-bottom: var(--space-16); }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); margin-bottom: var(--space-8); color: var(--color-text); }
        input, select, textarea { padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); font-size: var(--font-size-base); background: var(--color-background); color: var(--color-text); transition: border-color var(--duration-normal) var(--ease-standard); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-focus-ring); }
        select { appearance: none; background-image: var(--select-caret-light); background-repeat: no-repeat; background-position: right var(--space-12) center; background-size: 16px; padding-right: var(--space-32); }
        textarea { resize: vertical; min-height: 80px; font-family: var(--font-family-base); }
        .btn { padding: var(--space-12) var(--space-24); border: none; border-radius: var(--radius-base); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); }
        .btn-primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn-primary:hover { background: var(--color-primary-hover); }
        .btn-secondary { background: var(--color-secondary); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-secondary-hover); }
        .btn-danger { background: var(--color-error); color: var(--color-white); }
        .btn-danger:hover { opacity: 0.9; }
        .btn-small { padding: var(--space-8) var(--space-16); font-size: var(--font-size-sm); }
        .filter-section { background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-24); box-shadow: var(--shadow-sm); }
        .filter-row { display: flex; gap: var(--space-12); flex-wrap: wrap; align-items: flex-end; }
        .filter-row .form-group { flex: 1; min-width: 200px; }
        .table-container { background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--color-secondary); }
        th { padding: var(--space-16); text-align: left; font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-text); text-transform: uppercase; border-bottom: 1px solid var(--color-border); }
        td { padding: var(--space-16); font-size: var(--font-size-base); border-bottom: 1px solid var(--color-card-border); }
        tbody tr:hover { background: var(--color-secondary); }
        .badge { display: inline-block; padding: var(--space-4) var(--space-12); border-radius: 999px; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); }
        .badge-critical { background: rgba(var(--color-red-500-rgb), 0.15); color: var(--color-error); border: 1px solid rgba(var(--color-red-500-rgb), 0.25); }
        .badge-high { background: rgba(var(--color-orange-500-rgb), 0.15); color: var(--color-warning); border: 1px solid rgba(var(--color-orange-500-rgb), 0.25); }
        .badge-medium { background: rgba(var(--color-teal-500-rgb), 0.15); color: var(--color-primary); border: 1px solid rgba(var(--color-teal-500-rgb), 0.25); }
        .badge-low { background: rgba(var(--color-slate-500-rgb), 0.15); color: var(--color-text-secondary); border: 1px solid rgba(var(--color-slate-500-rgb), 0.25); }
        .badge-active { background: rgba(var(--color-red-500-rgb), 0.15); color: var(--color-error); border: 1px solid rgba(var(--color-red-500-rgb), 0.25); }
        .badge-monitored { background: rgba(var(--color-orange-500-rgb), 0.15); color: var(--color-warning); border: 1px solid rgba(var(--color-orange-500-rgb), 0.25); }
        .badge-mitigated { background: rgba(var(--color-teal-500-rgb), 0.15); color: var(--color-success); border: 1px solid rgba(var(--color-teal-500-rgb), 0.25); }
        .actions { display: flex; gap: var(--space-8); }
        .empty-state { text-align: center; padding: var(--space-32); color: var(--color-text-secondary); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-32); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-md); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24); }
        .modal-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); }
        .close-btn { background: none; border: none; font-size: var(--font-size-2xl); cursor: pointer; color: var(--color-text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .close-btn:hover { color: var(--color-text); }
        .modal-footer { display: flex; justify-content: flex-end; gap: var(--space-12); margin-top: var(--space-24); }
        .export-btn { margin-left: var(--space-12); }
        nav { margin-bottom: var(--space-24); padding: var(--space-16); background: var(--color-surface); border-radius: var(--radius-base); }
        nav a { margin-right: var(--space-20); text-decoration: none; color: var(--color-primary); font-weight: var(--font-weight-semibold); }
        nav a:hover { text-decoration: underline; }
        @media (max-width: 768px) {
            body { padding: var(--space-16); }
            .form-grid { grid-template-columns: 1fr; }
            .table-container { overflow-x: auto; }
            table { min-width: 800px; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="/">📊 Upload de Logs</a>
        <a href="/crud">🛡️ Gerenciar IOCs</a>
    </nav>

    <div class="container">
        <header>
            <h1>🛡️ IOC Analysis System</h1>
            <p class="subtitle">Sistema de Gerenciamento de Indicadores de Comprometimento</p>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total de IOCs</div>
                <div class="stat-value" id="totalIocs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Críticos</div>
                <div class="stat-value critical" id="criticalIocs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ativos</div>
                <div class="stat-value high" id="activeIocs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Mitigados</div>
                <div class="stat-value medium" id="mitigatedIocs">0</div>
            </div>
        </div>

        <div class="form-card">
            <h2 class="form-title">Adicionar Novo IOC</h2>
            <form id="iocForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="iocType">Tipo de IOC *</label>
                        <select id="iocType" required>
                            <option value="">Selecione...</option>
                            <option value="IP">Endereço IP</option>
                            <option value="Domain">Domínio</option>
                            <option value="URL">URL</option>
                            <option value="Hash">Hash (MD5/SHA256)</option>
                            <option value="Email">E-mail</option>
                            <option value="File">Nome de Arquivo</option>
                            <option value="Registry">Chave de Registro</option>
                            <option value="CVE">CVE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="iocValue">Valor do IOC *</label>
                        <input type="text" id="iocValue" placeholder="Ex: 192.168.1.1" required>
                    </div>
                    <div class="form-group">
                        <label for="severity">Severidade *</label>
                        <select id="severity" required>
                            <option value="">Selecione...</option>
                            <option value="Critical">Crítica</option>
                            <option value="High">Alta</option>
                            <option value="Medium">Média</option>
                            <option value="Low">Baixa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" required>
                            <option value="">Selecione...</option>
                            <option value="Active">Ativo</option>
                            <option value="Monitored">Monitorado</option>
                            <option value="Mitigated">Mitigado</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="source">Fonte</label>
                        <input type="text" id="source" placeholder="Ex: VirusTotal, AbuseIPDB">
                    </div>
                    <div class="form-group">
                        <label for="firstSeen">Primeira Detecção</label>
                        <input type="date" id="firstSeen">
                    </div>
                    <div class="form-group">
                        <label for="lastSeen">Última Detecção</label>
                        <input type="date" id="lastSeen">
                    </div>
                    <div class="form-group">
                        <label for="campaign">Campanha/Ameaça</label>
                        <input type="text" id="campaign" placeholder="Ex: APT28, Emotet">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: var(--space-16);">
                    <label for="description">Descrição/Notas</label>
                    <textarea id="description" placeholder="Informações adicionais sobre o IOC..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Adicionar IOC</button>
                <button type="button" class="btn btn-secondary export-btn" onclick="exportToJSON()">Exportar JSON</button>
            </form>
        </div>

        <div class="filter-section">
            <div class="filter-row">
                <div class="form-group">
                    <label for="filterType">Filtrar por Tipo</label>
                    <select id="filterType" onchange="applyFilters()">
                        <option value="">Todos</option>
                        <option value="IP">Endereço IP</option>
                        <option value="Domain">Domínio</option>
                        <option value="URL">URL</option>
                        <option value="Hash">Hash</option>
                        <option value="Email">E-mail</option>
                        <option value="File">Arquivo</option>
                        <option value="Registry">Registro</option>
                        <option value="CVE">CVE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterSeverity">Filtrar por Severidade</label>
                    <select id="filterSeverity" onchange="applyFilters()">
                        <option value="">Todas</option>
                        <option value="Critical">Crítica</option>
                        <option value="High">Alta</option>
                        <option value="Medium">Média</option>
                        <option value="Low">Baixa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterStatus">Filtrar por Status</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">Todos</option>
                        <option value="Active">Ativo</option>
                        <option value="Monitored">Monitorado</option>
                        <option value="Mitigated">Mitigado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchValue">Buscar IOC</label>
                    <input type="text" id="searchValue" placeholder="Digite para buscar..." oninput="applyFilters()">
                </div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Severidade</th>
                        <th>Status</th>
                        <th>Fonte</th>
                        <th>Campanha</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="iocTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            Nenhum IOC cadastrado. Adicione o primeiro IOC usando o formulário acima.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar IOC</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editType">Tipo de IOC</label>
                        <select id="editType" required>
                            <option value="IP">Endereço IP</option>
                            <option value="Domain">Domínio</option>
                            <option value="URL">URL</option>
                            <option value="Hash">Hash</option>
                            <option value="Email">E-mail</option>
                            <option value="File">Arquivo</option>
                            <option value="Registry">Registro</option>
                            <option value="CVE">CVE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editValue">Valor do IOC</label>
                        <input type="text" id="editValue" required>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editSeverity">Severidade</label>
                        <select id="editSeverity" required>
                            <option value="Critical">Crítica</option>
                            <option value="High">Alta</option>
                            <option value="Medium">Média</option>
                            <option value="Low">Baixa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus" required>
                            <option value="Active">Ativo</option>
                            <option value="Monitored">Monitorado</option>
                            <option value="Mitigated">Mitigado</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editSource">Fonte</label>
                        <input type="text" id="editSource">
                    </div>
                    <div class="form-group">
                        <label for="editCampaign">Campanha</label>
                        <input type="text" id="editCampaign">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFirstSeen">Primeira Detecção</label>
                        <input type="date" id="editFirstSeen">
                    </div>
                    <div class="form-group">
                        <label for="editLastSeen">Última Detecção</label>
                        <input type="date" id="editLastSeen">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">Descrição</label>
                    <textarea id="editDescription"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let iocs = [];

        // Carregar IOCs do servidor
        async function loadIocs() {
            try {
                const response = await fetch('/api/iocs');
                iocs = await response.json();
                updateStats();
                renderTable();
            } catch (error) {
                console.error('Erro ao carregar IOCs:', error);
            }
        }

        function updateStats() {
            const total = iocs.length;
            const critical = iocs.filter(ioc => ioc.severity === 'Critical').length;
            const active = iocs.filter(ioc => ioc.status === 'Active').length;
            const mitigated = iocs.filter(ioc => ioc.status === 'Mitigated').length;

            document.getElementById('totalIocs').textContent = total;
            document.getElementById('criticalIocs').textContent = critical;
            document.getElementById('activeIocs').textContent = active;
            document.getElementById('mitigatedIocs').textContent = mitigated;
        }

        function getSeverityBadgeClass(severity) {
            const classes = {
                'Critical': 'badge-critical',
                'High': 'badge-high',
                'Medium': 'badge-medium',
                'Low': 'badge-low'
            };
            return classes[severity] || 'badge-low';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'Active': 'badge-active',
                'Monitored': 'badge-monitored',
                'Mitigated': 'badge-mitigated'
            };
            return classes[status] || 'badge-monitored';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function renderTable(iocList = iocs) {
            const tbody = document.getElementById('iocTableBody');
            
            if (iocList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            Nenhum IOC encontrado com os filtros aplicados.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = iocList.map(ioc => `
                <tr>
                    <td>${ioc.type}</td>
                    <td><code>${ioc.value}</code></td>
                    <td><span class="badge ${getSeverityBadgeClass(ioc.severity)}">${ioc.severity}</span></td>
                    <td><span class="badge ${getStatusBadgeClass(ioc.status)}">${ioc.status}</span></td>
                    <td>${ioc.source || '-'}</td>
                    <td>${ioc.campaign || '-'}</td>
                    <td>${formatDate(ioc.firstSeen)}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary btn-small" onclick="editIoc(${ioc.id})">Editar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteIoc(${ioc.id})">Excluir</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const severityFilter = document.getElementById('filterSeverity').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const searchValue = document.getElementById('searchValue').value.toLowerCase();

            let filtered = iocs;

            if (typeFilter) {
                filtered = filtered.filter(ioc => ioc.type === typeFilter);
            }

            if (severityFilter) {
                filtered = filtered.filter(ioc => ioc.severity === severityFilter);
            }

            if (statusFilter) {
                filtered = filtered.filter(ioc => ioc.status === statusFilter);
            }

            if (searchValue) {
                filtered = filtered.filter(ioc => 
                    ioc.value.toLowerCase().includes(searchValue) ||
                    (ioc.source && ioc.source.toLowerCase().includes(searchValue)) ||
                    (ioc.campaign && ioc.campaign.toLowerCase().includes(searchValue)) ||
                    (ioc.description && ioc.description.toLowerCase().includes(searchValue))
                );
            }

            renderTable(filtered);
        }

        document.getElementById('iocForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newIoc = {
                id: Date.now(),
                type: document.getElementById('iocType').value,
                value: document.getElementById('iocValue').value,
                severity: document.getElementById('severity').value,
                status: document.getElementById('status').value,
                source: document.getElementById('source').value,
                firstSeen: document.getElementById('firstSeen').value,
                lastSeen: document.getElementById('lastSeen').value,
                campaign: document.getElementById('campaign').value,
                description: document.getElementById('description').value,
                createdAt: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/iocs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newIoc)
                });

                if (response.ok) {
                    await loadIocs();
                    this.reset();
                }
            } catch (error) {
                console.error('Erro ao adicionar IOC:', error);
            }
        });

        function editIoc(id) {
            const ioc = iocs.find(i => i.id === id);
            if (!ioc) return;

            document.getElementById('editId').value = ioc.id;
            document.getElementById('editType').value = ioc.type;
            document.getElementById('editValue').value = ioc.value;
            document.getElementById('editSeverity').value = ioc.severity;
            document.getElementById('editStatus').value = ioc.status;
            document.getElementById('editSource').value = ioc.source || '';
            document.getElementById('editCampaign').value = ioc.campaign || '';
            document.getElementById('editFirstSeen').value = ioc.firstSeen || '';
            document.getElementById('editLastSeen').value = ioc.lastSeen || '';
            document.getElementById('editDescription').value = ioc.description || '';

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('editId').value);
            const updatedIoc = {
                id: id,
                type: document.getElementById('editType').value,
                value: document.getElementById('editValue').value,
                severity: document.getElementById('editSeverity').value,
                status: document.getElementById('editStatus').value,
                source: document.getElementById('editSource').value,
                campaign: document.getElementById('editCampaign').value,
                firstSeen: document.getElementById('editFirstSeen').value,
                lastSeen: document.getElementById('editLastSeen').value,
                description: document.getElementById('editDescription').value,
                updatedAt: new Date().toISOString()
            };

            try {
                const response = await fetch(`/api/iocs/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedIoc)
                });

                if (response.ok) {
                    await loadIocs();
                    closeEditModal();
                }
            } catch (error) {
                console.error('Erro ao atualizar IOC:', error);
            }
        });

        async function deleteIoc(id) {
            if (confirm('Tem certeza que deseja excluir este IOC?')) {
                try {
                    const response = await fetch(`/api/iocs/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadIocs();
                    }
                } catch (error) {
                    console.error('Erro ao excluir IOC:', error);
                }
            }
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(iocs, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ioc_analysis_${new Date().toISOString().split('T')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Inicializar ao carregar a página
        loadIocs();
    </script>
</body>
</html>
